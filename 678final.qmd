---
title: "Walmart weekly sales mid-term project"
author: "Yingmai Chen"
format:
  pdf:
    keep-tex: true
    latex-engine: xelatex
header-includes:
  - "\\usepackage{fontspec}"
  - "\\setmainfont{Times New Roman}"
  - "\\usepackage{setspace}"
  - "\\setstretch{1.25}"
  - "\\fontsize{9pt}{12pt}\\selectfont"
---
```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(ggplot2)
library(lme4)
library(Matrix)
library(lmerTest)
library(MuMIn)
library(lubridate)
library(caret)
library(broom)
library(corrplot)
```


```{r echo=FALSE}
data<-read.csv("walmart.csv")
```


# I.Abstract
 The project aims to find the relationship between weekly sales of walmart with other variables,and also want to find which variable is more correlated with weekly sales,and the project will include six parts:"Abstract","Introduction","method","results","discussion","appendix".
 The first two parts are the descriptions of this project,and the method part would have two parts:EDA(Exploratory Data Analysis),and model.The results would be the comparison and illustration of the model.Discussion part would discuss some future questions about my project,appendix would include some poorly visualized graphs. 
 
# II.Introduction
In this study, we leveraged a dataset from Kaggle to identify and quantify various factors impacting weekly sales. The dataset includes key variables  such as holidays, oil prices, temperature, unemployment rates, and the Consumer Price Index (CPI), we utilized regression analysis to assess the relative impact of these variables on sales volumes.Through this study, we hope to offer a more comprehensive and accurate sales forecasting model, helping businesses better understand market dynamics and make more effective business decisions.

# III.Method

I check the summary of the data first and see there don't have NA's in the data,so we don't need to deal with the missing value of data.

## EDA
```{r echo=FALSE}
data$Date <- as.Date(data$Date, format="%m-%d-%Y")
data$Holiday_Flag <- as.factor(data$Holiday_Flag)
```


```{r distribution-plot,echo=FALSE}
ggplot(data, aes(x =Weekly_Sales)) + 
  geom_histogram(binwidth = 100000, fill = "lightblue", color = "black") +
  labs(title = "Distribution of Weekly Sales", x = " Weekly Sales", y = "Frequency of weekly sales")

```
### description

 From this plot,we can see that there are fewer weeks with very high sales
 compared to weeks with low sales.This is typical for sales data where a
 small number of periods (like holiday seasons) might have exceptionally high sales.

```{r bin-plot,fig.width=10, fig.height=8, echo=FALSE}
grouped_data <- data %>%
  group_by(Store) %>%
  summarise(median_sales = median(Weekly_Sales, na.rm = TRUE),
            sd_sales = sd(Weekly_Sales, na.rm = TRUE))


ggplot(grouped_data, aes(x = as.factor(Store), y = median_sales)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  geom_errorbar(aes(ymin = median_sales - sd_sales, ymax = median_sales + sd_sales,
                    color = "Standard Deviation"), width = 0.2, position = position_dodge(0.9)) +
  scale_color_manual(name = "Legend", values = "red", labels = "Standard Deviation") +
  labs(title = "Median Weekly Sales by Store ",
       x = "Store Number", y = "Median Weekly Sales") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

```
### description

From this plot,we can see there exist obvious differences between each store,some has higher median of weekly sales, and some would have bigger error bar which means sales are more volatile.this suggests that we should trying multilevel model in the model part. 


```{r box-plot,echo=FALSE}
data %>% 
  ggplot(aes(as_factor(Holiday_Flag), Weekly_Sales)) +
    geom_boxplot() + 
  labs(title = "Boxplot of Holiday Flag",
       x = "Holiday Flag", 
       y = "Weekly Sales") + 
 theme_bw()
```
### description

From this plot, we can see that  the median of holiday weekly sales is a little bit higher than non-holiday weekly sale, and the numbers of outliers in non-holiday weekly sales are more than holiday-weekly sales,based on this,I think there would have some relationships between holidays and weekly sales.

```{r line-plot,echo=FALSE,warning=FALSE}
date_grouped_data <- data %>%
  group_by(Date) %>%
  summarise(median_sales = median(Weekly_Sales, na.rm = TRUE))

ggplot(date_grouped_data, aes(x = Date, y = median_sales)) +
  geom_line(color = "blue", size = 1) +
  geom_point(color = "darkred", size = 2) +
  labs(title = "Median Weekly Sales by Date",
       x = "month of year", y = "Median Weekly Sales") +
  theme_minimal() +
  theme(
    panel.grid.major = element_line(color = "gray", size = 0.5),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(hjust = 0.5)
  ) +
  scale_x_date(date_breaks = "1 month", date_labels = "%Y.%m")  # Adjusted date format

```

### description

From this plot,we can see that there is a recurring trend of lower sales at the beginning of each year. This dip in sales could be attributed to post-holiday season effects, where consumer spending typically drops following the end-of-year holidays,which means the date would have impact on weekly sales.

```{r matrix-plot,echo=FALSE,message=FALSE}
data1 <- data[, !names(data) %in% c("Store","Date")]
data1 <- data1 %>%
  mutate_if(is.factor, as.character) %>% 
  mutate_if(is.character, function(x) as.numeric(as.character(x))) 
cor_matrix <- cor(data1, use = "complete.obs")
library(reshape2) 

melted_cor_matrix <- melt(cor_matrix)

ggplot(melted_cor_matrix, aes(Var1, Var2, fill = value)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                       midpoint = 0, limit = c(-1,1), space = "Lab", 
                       name="Pearson\nCorrelation") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, 
                                   size = 12, hjust = 1),
        axis.text.y = element_text(size = 12)) +
  coord_fixed()
```

### description

As we can see, from this plot,It is not obvious that these variables are correlated to weekly sales.

## Model

Because we can not easily draw a conclusion by doing EDA,so the next step for us shoud be modeling,

### model1:null model

```{r echo=FALSE,results='hide'}
null_model <- lm(Weekly_Sales ~ 1, data = data)
print(null_model)
summary(null_model)
residuals <- residuals(null_model)
mse <- mean(residuals^2)
print(mse)
```

### model2:simple linear model(complete pooling model)

```{r echo=FALSE,results='hide'}
predictors <- c('Store', 'Holiday_Flag', 'Temperature', 'Fuel_Price', 'CPI', 'Unemployment')
target <- 'Weekly_Sales'

set.seed(42) 
trainIndex <- createDataPartition(data[[target]], p = .8, 
                                  list = FALSE, 
                                  times = 1)
data_train <- data[trainIndex,]
data_test <- data[-trainIndex,]

model <- lm(log(Weekly_Sales) ~ Store + Holiday_Flag + Temperature + Fuel_Price + CPI + Unemployment, data=data_train)
summary(model)

predictions <- predict(model, data_test)

```


### model3:multilevel model(No pooling model)

```{r echo=FALSE,results='hide'}
models <- data %>%
  group_by(Store) %>%
  do(model = lm(log(Weekly_Sales) ~ Temperature + Fuel_Price + CPI + Unemployment, data = .))
model_summaries <- models %>% 
  rowwise() %>% 
  do(tidy(.$model))
print(model_summaries)
```
### model4:generalized linear Model
```{r echo=FALSE,results='hide'}
model <- glm(log(Weekly_Sales) ~ Store + Holiday_Flag + Temperature + Fuel_Price + CPI + Unemployment, 
             data = data, 
             family = gaussian())
summary(model)
```

# IV.result

# V.discussion

# VI.appendix

```{r echo=FALSE}

ggplot(data, aes(x = CPI, y = Weekly_Sales)) +
  geom_point() +
  labs(title = "Scatterplot of CPI vs. Weekly Sales",
       x = "CPI",
       y = "Weekly Sales")

```

From this plot, we can hardly see if there exist relationships between CPI and weekly sales. 

```{r echo=FALSE}
ggplot(data, aes(x = Temperature, y = Weekly_Sales)) +
  geom_point() +
  labs(title = "Scatterplot of Temperature vs. Weekly Sales",
       x = "Temperature",
       y = "Weekly Sales")
```

From this plot,we can see temperatures from 25 to 75 of the country tend to have much more numbers of higher weekly sales.

```{r echo=FALSE}
ggplot(data, aes(x = Fuel_Price, y = Weekly_Sales)) +
  geom_point() +
  labs(title = "Scatterplot of Fuel Price vs. Weekly Sales",
       x = "Fuel Price",
       y = "Weekly Sales")
```


From this plot, we can hardly see if there exist relationships between fuel price and weekly sales.

```{r echo=FALSE}
ggplot(data, aes(x = Unemployment, y = Weekly_Sales)) +
  geom_point() +
  labs(title = "Scatterplot of Unemployment vs. Weekly Sales",
       x = "Unemployment",
       y = "Weekly Sales")
```

From this plot,we can see the less of proportions of unemployment tends to have higher weekly sales.